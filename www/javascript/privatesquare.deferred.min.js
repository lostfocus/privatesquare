function privatesquare_pending_init(){var a=privatesquare_deferred_list();if(a.length==0){privatesquare_set_status("There are no pending checkins to administriviate.");privatesquare_hide_map();$("#pending-form").hide()}else{var b=function(h){var i=Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");h.getFullYear();var e=h.getDate();return i[h.getMonth()]+" "+e},c="<optgroup>";for(var d in a){var f=a[d],g=new Date(f.created*1E3);c+='<option value="'+htmlspecialchars(f.id)+
'">';c+=b(g)+' at "';c+=htmlspecialchars(f.venue);c+='"</option>'}c+="</optgroup>";$("#checkins").html(c);b=$("#meh");b.show();b.click(privatesquare_pending_purge_checkins);b=$("#deferred");b.attr("data-count-pending",a.length);b.show();b.submit(privatesquare_pending_onselect);privatesquare_pending_show_map(a)}}
function privatesquare_pending_onselect(){privatesquare_hide_map();$("#deferred").hide();var a=$("#checkins").val();a=privatesquare_deferred_get_by_id(a);$("#whatnow").val()=="delete"?privatesquare_pending_delete_checkin(a):privatesquare_pending_fetch_venues(a);return false}
function privatesquare_pending_fetch_venues(a){var b={query:'"'+a.venue+'"'};if(a.latitude&&a.longitude){b.latitude=a.latitude;b.longitude=a.longitude}else b.near=a.near;privatesquare_api_call("foursquare.venues.search",b);privatesquare_set_status("Looking for '"+htmlspecialchars(a.venue)+"'")}
function _privatesquare_pending_fetch_venues_onload(a){privatesquare_unset_status();if(a.stat!="ok")privatesquare_api_error(a);else{var b=a.venues.length;if(b){var c="";c+="<optgroup>";for(var d=0;d<b;d++){var f=a.venues[d];c+='<option value="'+f.id+'">'+f.name+"</option>"}c+="</optgroup>";d=$("#where");d.attr("data-crumb",a.crumb);d.attr("data-checkin-id",a.checkin.id);d.html(c);$("#what").attr("disabled","disabled");$("#broadcast").attr("disabled","disabled");if(a.latitude&&a.longitude)privatesquare_show_map(a.latitude,
a.longitude,'"'+a.checkin.venue+'"');else{c=a.venues.length;b=[];var g=f=null,h=null,i=null;for(d=0;d<c;d++){var e=a.venues[d],j=e.name,k=e.location.lat;e=e.location.lng;f=f==null?k:Math.min(f,k);g=g==null?e:Math.min(g,e);h=h==null?k:Math.max(h,k);i=i==null?e:Math.max(i,e);b.push([k,e,j])}privatesquare_show_map_bbox([f,g,h,i],b)}$("#venues").show();d=$("#meh");d.click(function(){privatesquare_pending_delete_checkin(a.checkin)});d.show();$("#checkin").submit(_privatesquare_pending_onsubmit)}else{d=
"Ack! foursquare can't find anything like '"+htmlspecialchars(a.checkin.venue)+"' around those parts.";d+=" Also, privatesquare isn't smart enough to deal with this situation yet...";privatesquare_set_status(d)}}}
function _privatesquare_pending_onsubmit(){var a=$("#where"),b=$("#whatnow");a=a.attr("data-checkin-id");var c=privatesquare_deferred_get_by_id(a);if(b.val()=="delete"){confirm("Are you sure you want to delete this pending checkin?")&&privatesquare_pending_delete_checkin(c);return false}$("#venues").hide();$("#meh").hide();privatesquare_hide_map();b=privatesquare_gather_args();b.created=c.created;privatesquare_checkin(b,function(d){d.checkin=c;_privatesquare_pending_checkin_onload(d)});privatesquare_set_status("Checking in...");
return false}function privatesquare_pending_purge_checkins(){var a="Are you sure you want to delete all those pending checkins?",b=$("#deferred");if(b.attr("data-count-pending")==1)a="Are you sure you want to delete all this checkin?";if(!confirm(a))return false;b.hide();privatesquare_deferred_purge();privatesquare_set_status("Okay all your pending checkins have been deleted.");return false}
function privatesquare_pending_delete_checkin(a){if(confirm("Are you sure you want to delete this pending checkin?")){$("#venues").hide();$("#meh").hide();privatesquare_hide_map();privatesquare_deferred_remove(a.id);if(privatesquare_deferred_list().length==0)privatesquare_set_status("All your pending checkins have been encheckin-ified (or deleted).");else{privatesquare_set_status("Your checkin at '"+htmlspecialchars(a.venue)+"' has deleted.");privatesquare_pending_init()}}}
function _privatesquare_pending_checkin_onload(a){if(a.stat!="ok")privatesquare_api_error(a);else{privatesquare_deferred_remove(a.checkin.id);if(privatesquare_deferred_list().length==0)privatesquare_set_status("All your pending checkins have been encheckin-ified!");else{privatesquare_set_status("Your checkin at '"+htmlspecialchars(a.checkin.venue)+"' has been encheckin-ified!");privatesquare_pending_init()}}}
function privatesquare_pending_show_map(a){var b=[],c=null,d=null,f=null,g=null;for(var h in a){var i=a[h],e=parseFloat(i.latitude),j=parseFloat(i.longitude);if(e&&j){i=e+","+j;c=c==undefined?e:Math.min(c,e);d=d==undefined?j:Math.min(d,j);f=f==undefined?e:Math.max(f,e);g=g==undefined?j:Math.max(g,j);e="<div";e+=' class="marker marker-header"';e+=' data-location="'+i+'">';e+='<span class="marker-history-text"></span>';e+="</div>";b.push(e)}}if(b.length!=0){h=$("#map-wrapper");e=document.createElement("div");
e=$(e);e.attr("class","map");if(a.length==1){i=c+","+d;e.attr("data-location",i);e.attr("data-zoom",14)}else{a=[c,d,f,g].join(",");e.attr("data-extent",a)}e.attr("data-hash",false);e.attr("data-touch",true);e.attr("data-provider","toner");e.html(b.join(""));h.html(e);h.show();privatesquare_htmapl(e)}};function privatesquare_deferred_has_local_storage(){try{new Store("privatesquare");return 1}catch(a){return 0}}
function privatesquare_deferred_checkin(a,b,c){a&&b&&privatesquare_show_map(a,b);privatesquare_unset_status();if(c=="offline")c="I've lost the network";else if(c=="api error")c="foursquare is sad";if(privatesquare_deferred_has_local_storage()){privatesquare_set_status(htmlspecialchars(c)+" / would you like to write a postcard to the future?");c=$("#deferred_where");c.val("");if(a&&b){c.attr("data-latitude",a);c.attr("data-longitude",b)}else{a=$("#deferred_city");a.val("");a.show()}$("#deferred_checkin").submit(privatesquare_deferred_checkin_submit);
$("#deferred").show()}else privatesquare_set_status(htmlspecialchars(c)+" / your browser can't store deferred checkins / sad browser is sad")}function privatesquare_deferred_checkin_submit(){var a=parseInt((new Date).getTime()/1E3),b=$("#deferred_where"),c=b.val(),d=$("#deferred_city").val();a={id:c+"#"+a,venue:c,latitude:b.attr("data-latitude"),longitude:b.attr("data-longitude"),near:d,created:a};privatesquare_deferred_store(a,privatesquare_deferred_checkin_stored);return false}
function privatesquare_deferred_checkin_stored(a){privatesquare_set_status("Okay! Your checkin at '"+a.venue+"' has been recorded.");privatesquare_hide_map();$("#deferred_checkin").hide()}
function privatesquare_deferred_indicator(){var a=(new Store("privatesquare")).get("deferred");a=a?Object.keys(a).length:0;var b=$("#pending"),c=$("#pending_count");if(a==1){c.html('<a href="'+privatesquare_abs_root_url()+'me/pending/">(1) pending checkin</a>');b.show()}else if(a){c.html('<a href="'+privatesquare_abs_root_url()+'me/pending/">('+a+") pending checkins</a>");b.show()}else{c.html("");b.hide()}}
function privatesquare_deferred_list(a){a=a?a.toLowerCase():"asc";var b=(new Store("privatesquare")).get("deferred"),c=[];if(!b)return c;for(var d in b)c.push(b[d]);c.sort(function(f,g){if(f.created<g.created)return a=="desc"?1:-1;if(f.created>g.created)return a=="desc"?-1:1;return 0});return c}function privatesquare_deferred_store(a,b){var c=new Store("privatesquare"),d=c.get("deferred");d||(d={});d[a.id]=a;c.set("deferred",d);c=null;if(b)c=function(){b(a)};_privatesquare_deferred_onupdate(c)}
function privatesquare_deferred_get_by_id(a){var b=(new Store("privatesquare")).get("deferred");if(b)return b[a];return null}function privatesquare_deferred_remove(a,b){var c=new Store("privatesquare"),d=c.get("deferred");if(d){delete d[a];c.set("deferred",d)}_privatesquare_deferred_onupdate(b)}function privatesquare_deferred_purge(a){var b=new Store("privatesquare");b.get("deferred")&&b.remove("deferred");_privatesquare_deferred_onupdate(a)}
function _privatesquare_deferred_onupdate(a){privatesquare_deferred_indicator();a&&a()};
