var checking_in=false,searching=false;
function privatesquare_init(a){a||(a="foursquare");$("body").attr("data-privatesquare-provider",a);privatesquare_whereami(function(b){var c=b.coords.latitude;b=b.coords.longitude;var d=$("#venues");d.attr("data-geolocation-latitude",c);d.attr("data-geolocation-longitude",b);if(a=="stateofmind")privatesquare_stateofmind_fetch_venues(c,b);else if(a=="nypl")privatesquare_nypl_fetch_venues(c,b);else a=="privatesquare"?privatesquare_venues_fetch_venues(c,b):privatesquare_foursquare_fetch_venues(c,b)},
function(b){console.log(b);privatesquare_set_status("Huh. I have no idea where you are...")});$("#checkin").submit(privatesquare_submit);$("#again").click(privatesquare_reset);privatesquare_set_status("Asking the sky where you are...")}function privatesquare_reset(){$("#venues").hide();privatesquare_unset_status();privatesquare_hide_map();privatesquare_init()}
function privatesquare_submit(){var a=privatesquare_gather_args();if(a.venue_id==-1){privatesquare_search();return false}privatesquare_checkin(a,privatesquare_checkin_onsuccess);$("#venues").hide();privatesquare_hide_map();privatesquare_set_status("Checking in...");return false}
function privatesquare_gather_args(){var a=$("#venues"),b=a.attr("data-venues-provider"),c=a.attr("data-geolocation-latitude");a=a.attr("data-geolocation-longitude");var d=$("#where").val(),e=$("#what").val(),f=$("#broadcast").val();b||(b=$("body").attr("data-privatesquare-provider"));f=e==2?"":f;b={crumb:$("#where").attr("data-crumb"),venue_id:d,provider:b,status_id:e,broadcast:f};if(c&&a){b.latitude=c;b.longitude=a}return b}
function privatesquare_checkin(a,b){if(checking_in)return false;b||(b=privatesquare_checkin_onsuccess);checking_in=true;privatesquare_api_call("privatesquare.venues.checkin",a,b,function(){checking_in=false})}
function privatesquare_search(){if(searching)return false;searching=true;privatesquare_hide_map();$("#venues").hide();var a=prompt("Search for a particular place");if(!a){var b=$("#venues").attr("data-venues-provider");privatesquare_set_status('Okay, I\'m giving up. <a href="#" onclick="privatesquare_init();return false;">Start over</a> if you want change your mind.');return false}b=privatesquare_venues_provider();var c=null;console.log("provider is "+b);if(b=="foursquare")c=function(d){privatesquare_foursquare_fetch_venues(d.coords.latitude,
d.coords.longitude,a);searching=false};else if(b=="nypl")c=function(d){privatesquare_nypl_fetch_venues(d.coords.latitude,d.coords.longitude,a);searching=false};else{privatesquare_set_status("Hrm... I don't know how to search for that","warning");return false}privatesquare_whereami(c,function(){});privatesquare_set_status("Re-checking your location first...");return false}function _privatesquare_where_onchange(){$("#where").val()==-1&&privatesquare_search();return false}
function _privatesquare_what_onchange(){var a=$("#what").val(),b=$("#broadcast"),c=$("body").attr("data-privatesquare-provider");if(a==2)b.attr("disabled","disabled");else c!="stateofmind"&&b.removeAttr("disabled")}function privatesquare_checkin_onsuccess(a,b){$("#status").html("");b||(b=privatesquare_init);if(a.stat!="ok")privatesquare_api_error(a,b);else{var c=privatesquare_abs_root_url()+"venue/"+a.checkin.venue_id+"?success=1";location.href=c}}
function privatesquare_api_error(a,b){var c="Oh noes. There was a problem completing your request. ",d=a.error;if(d){c+="The robot monkeys report: ";c+=d.error+" (error code #"+d.code+"). "}else c+="It appears to be a privatesquare problem rather than foursquare weirdness. ";if(b){c+='<button id="tryagain" class="btn">Try it again?</button>';c+="&#160;&#160;";c+='<button id="donot_tryagain" class="btn">Forget it</button>'}privatesquare_set_status(c,"warning");if(b){$("#tryagain").click(b);$("#donot_tryagain").click(function(){$("#status").html("");
$("#status").hide()})}}function privatesquare_show_map(a,b,c){c||(c="you are here-ish");a=a+","+b;b=$("#map-wrapper");var d=document.createElement("div");d=$(d);d.attr("class","map");d.attr("data-zoom",14);d.attr("data-center",a);d.attr("data-hash",false);d.attr("data-touch",true);d.attr("data-provider","toner");var e=document.createElement("div");e=$(e);e.attr("class","marker");e.attr("data-location",a);e.html(htmlspecialchars(c));d.html(e);b.html(d);b.show();privatesquare_htmapl(d)}
function privatesquare_show_map_bbox(a,b){var c=$("#map-wrapper"),d=document.createElement("div");d=$(d);d.attr("class","map");d.attr("data-extent",a.join(","));d.attr("data-hash",false);d.attr("data-touch",true);d.attr("data-provider","toner");for(var e=[],f=b.length,g=0;g<f;g++){var h=b[g];h=h[0]+","+h[1];var i=document.createElement("div");i=$(i);i.attr("class","marker marker-header");i.attr("data-location",h);e.push(i.clone().wrap("<div/>").parent().html())}e.length&&d.html(e.join(""));c.html(d);
c.show();privatesquare_htmapl(d)}function privatesquare_htmapl(a){a||(a=$(".map"));try{a.htmapl()}catch(b){a.html('<div class="map-error alert alert-warning">hrmph...failed to load map: '+b+"</div>")}}function privatesquare_hide_map(){var a=$("#map-wrapper"),b=$(".map");a.hide();b.remove()}
function privatesquare_set_status(a,b){b||(b="info");var c='<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>';c+=a;$("#status").attr("class","alert alert-dismissable alert-"+b);$("#status").html(c);$("#status").show()}function privatesquare_unset_status(){$("#status").html("");$("#status").hide()}
function privatesquare_whereami(a,b){try{navigator.geolocation.getCurrentPosition(a,b,{enableHighAccuracy:true,maximumAge:1E3})}catch(c){alert("The sky is angry offering only this, today: "+c)}}function privatesquare_abs_root_url(){return document.body.getAttribute("data-abs-root-url")}function privatesquare_venues_provider(){return $("body").attr("data-privatesquare-provider")};function privatesquare_venues_fetch_venues(a,b){$("#broadcast").attr("disabled","disabled");privatesquare_api_call("privatesquare.venues.search",{latitude:a,longitude:b},_privatesquare_venues_fetch_venues_onsuccess);privatesquare_set_status("Fetching nearby places...")}
function _privatesquare_venues_fetch_venues_onsuccess(a){privatesquare_unset_status();if(a.stat!="ok")privatesquare_whereami(function(f){privatesquare_deferred_checkin(f.coords.latitude,f.coords.longitude,"api error")},function(){privatesquare_api_error(a)});else{for(var b=a.venues.length,c="",d=0;d<b;d++){var e=a.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);b.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);
privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(privatesquare_submit)}};function privatesquare_foursquare_fetch_venues(a,b,c){a={latitude:a,longitude:b};if(c!="")a.query=c;privatesquare_api_call("foursquare.venues.search",a,_privatesquare_foursquare_fetch_venues_onsuccess);privatesquare_set_status("Fetching nearby places...")}
function _privatesquare_foursquare_fetch_venues_onsuccess(a){privatesquare_unset_status();if(a.stat!="ok")privatesquare_whereami(function(f){privatesquare_deferred_checkin(f.coords.latitude,f.coords.longitude,"api error")},function(){privatesquare_api_error(a)});else{var b=a.venues.length;if(b){$("#venues").attr("data-venues-provider","foursquare");for(var c="",d=0;d<b;d++){var e=a.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';
b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);b.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(privatesquare_submit)}else{c="You appear to have fallen in to a black hole. There's nothing around here";if(a.query)c+=" that looks like <q>"+htmlspecialchars(a.query)+"</q>";c+='. <a href="#" onclick="privatesquare_search();return false;">Try again</a>';
c+=' or <a href="#" onclick="privatesquare_init();return false;">start from scratch</a>?';privatesquare_set_status(c)}}};function privatesquare_nypl_fetch_venues(a,b,c){var d=[40.495682,-74.255653,40.917622,-73.689484];if(a<d[0]||a>d[2]||b<d[1]||b>d[3]){privatesquare_set_status("Hrm... You don't appear to be in the New York area!");return false}$("#broadcast").attr("disabled","disabled");$("#venues").attr("data-venues-provider","nypl");a={latitude:a,longitude:b};if(c!="")a.query=c;privatesquare_api_call("nypl.venues.search",a,_privatesquare_nypl_fetch_venues_onsuccess);privatesquare_set_status("Asking the NYPL for buildings nearby...")}
function _privatesquare_nypl_fetch_venues_onsuccess(a){privatesquare_unset_status();if(a.stat=="ok"){var b=a.venues.length;if(b){for(var c="",d=0;d<b;d++){var e=a.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);b.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();
$("#venues").show();$("#checkin").submit(privatesquare_submit)}else{c="You appear to have fallen in to a black hole. There's nothing around here";if(a.query)c+=" that looks like <q>"+htmlspecialchars(a.query)+"</q>";c+='. <a href="#" onclick="privatesquare_nypl_search();return false;">Try again</a>';c+=' or <a href="#" onclick="privatesquare_init(\'nypl\');return false;">start from scratch</a>?';privatesquare_set_status(c)}}};function privatesquare_stateofmind_fetch_venues(a,b){$("#what option").each(function(){var c=$(this);c.val()>1&&c.attr("disabled","disabled")});$("#broadcast").attr("disabled","disabled");privatesquare_api_call("stateofmind.venues.search",{latitude:a,longitude:b},_privatesquare_stateofmind_fetch_venues_onsuccess);privatesquare_set_status("Fetching nearby places...")}
function _privatesquare_stateofmind_fetch_venues_onsuccess(a){privatesquare_unset_status();if(a.stat!="ok")privatesquare_whereami(function(f){privatesquare_deferred_checkin(f.coords.latitude,f.coords.longitude,"api error")},function(){privatesquare_api_error(a)});else{$("#venues").attr("data-venues-provider","stateofmind");for(var b=a.venues.length,c="",d=0;d<b;d++){var e=a.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);b.change(_privatesquare_where_onchange);
$("#what").change(_privatesquare_what_onchange);privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(privatesquare_submit)}};function privatesquare_api_call(a,b,c,d){var e=privatesquare_api_endpoint();b.method=a;$.ajax({url:e,type:"POST",data:b,dataType:"json",success:function(f){c&&c(f)},error:function(f){f=function(g){if(g.responseText)try{return g=JSON.parse(g.responseText)}catch(h){console.log("Failed to parse response text")}else console.log("Missing response text")}(f);d&&d(f)}})}function privatesquare_api_endpoint(){return document.body.getAttribute("data-api-endpoint")};
